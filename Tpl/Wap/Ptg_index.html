<!doctype html>
<html>
<head>
    <title>拼团购</title>
    <meta charset="utf-8" />
		<!--页面优化-->
		<meta name="MobileOptimized" content="320">
		<!--默认宽度320-->
		<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
		<!--viewport 等比 不缩放-->
		<meta http-equiv="cleartype" content="on">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<!--删除苹果菜单-->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<!--默认颜色-->
		<meta name="apple-mobile-web-app-title" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<!--加载全部后 显示-->
		<meta content="telephone=no" name="format-detection" />
		<!--不识别电话-->
		<meta content="email=no" name="format-detection" />
		<link rel="stylesheet" href="__PUBLIC__/wap/css/fxstyle.css" />
	    <!--组件依赖js begin-->
	    <script src="__PUBLIC__/wap/js/zepto.min.js"></script>
	    <!--组件依赖js end-->		
		<script type="text/javascript" src="__PUBLIC__/wap/gmu/gmu.min.js"></script>
        <script type="text/javascript" src="__PUBLIC__/wap/gmu/Joel-basegmu.js"></script>
        
    
		<style>
		a,a:hover{ text-decoration:none; color:#333}
			.headiconwp{text-align: center;}
			.headicon{width: 100%; border-radius:100px;}
			.cutmsg{font-size: 2em; font-weight:bold ; text-align: center;}
			.t-c{text-align: center;}
			.cutinfo{ font-size: 1em;}
			.bred{ color: #f7194d; font-size:1.5em ;}
			.sgre{ color: #9d9c9c; font-size: 0.8em;text-decoration:line-through}
			
			/*砍价日至*/
			.cutlog { padding-bottom: 5px; margin-bottom: 5px; border-bottom: 1px dotted #9c9c9c;}
			.cutlog .left{ float: left; width: 60px;}
			.cutlog .left2{ float: left; padding-left: 10px; vertical-align: middle; height: 100%;}
			.cutlog .right{ float: right;}
			.cutlog span{ text-decoration:inherit ; color: #9c9c9c; text-align: right; font-size: 0.8em;}
			.clear{clear: both;}
			/*选择框*/
			#msgopt{ width: 100%; border: 1px solid #CCCCCC; line-height: 1em; height: 1.5em; font-size: 1em;}
			/*主控按钮*/
			.J-btn{ width: 90%; margin: 0px auto; text-align: center; line-height: 2em; margin-bottom: 1em;}
			a.J-btn-red,a.J-btn-red:visited{ background: #f7194d; color: #FFFFFF; width: 40%; text-align: center; border-radius: 10px;  display: block; margin: 0px auto;}
			a.J-btn-red2,a.J-btn-red2:visited{ background: #f7194d; color: #FFFFFF; width: 40%; text-align: center; border-radius: 10px; float: left;display: block;}
			a.J-btn-green,a.J-btn-green:visited{ background: #2bb8aa; color: #FFFFFF;width: 40%; text-align: center; border-radius: 10px; float: right;display: block;}
			a.J-btn-gre,a.J-btn-gre:visited{ background: #999999; color: #FFFFFF;width: 40%; text-align: center; border-radius: 10px; float: left;display: block;}
			/*拼团购规则*/
			.FL{float:left;}
			.FR{float:right}
			.ptg-sj{width: 0;height: 0;border-width: 12px;border-style: solid;border-color: transparent transparent #676767 transparent;margin:0 auto;}
			.ptg-fqz{width:100%;background: #676767;}
			.ptg-headicon{padding:1% 2%;border-radius: 50%;}
			.ptg-mst{width:43%;text-align: center;font-size: 0.9em;overflow: hidden;}
			.ptg-cor1{color:#FFF;}
			.ptg-cor2{color:#999;}
			.ptg-gz{width:100%;border-top:1px solid #999;border-bottom:1px solid #999;background: #FFF;}
			.ptg-ct{background: #E7E5E5;}
			.ptg-xy{width:6.5%;height:20px;border-right:1px dashed #999999;}
			.hdxq{width:30%;line-height:1.2em;font-size: 1em;padding:2% 0 3% 2%;}
		</style>
</head>
<body class="back1 ">
	
	<eq name="isself" value="0">
		<div class="ads-lst border-b1 ovflw mr-b back2 color6 border-t1">
			<p class="ads-tt border-b1 color9">订单明细</p>
			<volist name="cache.items" id="vt">
				<div class="ads_orinfo ads_padding3 ovflw border-b1">
					<div class="ads_orinfol ovflw fl">
						<div class="ads_or_img fl">
							<!-- 图片大小为147*101 -->
							<img  src="{$vt.pic}"/>
						</div>
						<h3>{$vt.name}</h3>
						<notempty name="vt.skuattr">
						<p class="color3 fonts2">{$vt.skuattr}</p>
						</notempty>
					</div>
					<div class="ads_orprice ovflw ">
						<p ><em class="fonts85">￥</em><em class="fonts18">{$vt.price}</em></p>
						<p class="ads_ornum fonts85">X{$vt.num}</p>
					</div>
				</div>
			</volist>
			<!-- 支付方式 -->
			<!--<p class=" ads_ortt3 fonts85 ovflw border-b1"><span class="fl">共{$cache.totalnum}件商品</span><span class="fr">总价：<em class="fonts18">￥{$cache.totalprice}</em></span></p>-->
			<p class="dtl-pty">数量：</p>
			<div class="ovflw dtl_num fl">
				<a href="#" class="dtl_mar1" id="goods-dec">-</a>
				<input type="text" value="1" class="fl dtl_input dtl_mar1" id="goods-total" disabled="disabled"/>
				<a href="#" class="" id="goods-add">+</a>
			</div>
			<span class="fr dtl-sy">剩余：<em id="goods-num">{$goodinfo.num}</em>件</span>
			<span id="finalsku" data-sku = "" data-skuattr="" style="display: none;"></span>
			<div class="clear"></div>
			
			
			
		</div>
	<else />
		<div class="ads-lst border-b1 ovflw mr-b back2 color6 border-t1">
			<p class="ads-tt border-b1 color9">订单明细</p>
			<volist name="cache.items" id="vt">
				<div class="ads_orinfo ads_padding3 ovflw border-b1">
					<div class="ads_orinfol ovflw fl">
						<div class="ads_or_img fl">
							<!-- 图片大小为147*101 -->
							<img  src="{$vt.pic}"/>
						</div>
						<h3>{$vt.name}</h3>
						<notempty name="vt.skuattr">
						<p class="color3 fonts2">{$vt.skuattr}</p>
						</notempty>
					</div>
					<div class="ads_orprice ovflw ">
						<p ><em class="fonts85">￥</em><em class="fonts18">{$vt.price}</em></p>
						<p class="ads_ornum fonts85">X{$vt.num}</p>
					</div>
				</div>
			</volist>
			<!-- 支付方式 -->
			<p class=" ads_ortt3 fonts85 ovflw border-b1"><span class="fl">共{$cache.totalnum}件商品</span><span class="fr">总价：<em class="fonts18">￥{$cache.totalprice}</em></span></p>
		</div>
	</eq>


		<div class="odrd_cc back2 ovflw color9 border-b1 border-t1 mr-b" >
			<div class="border-b1 odrd_tt">订单主人</div>
				<p style="line-height: 5px;">&nbsp;</p>
				<p class="headiconwp"><img src="{$zr.headimgurl}" class="headicon" style="width: 80px;"></p>
				<p class="cutmsg" style="font-size: 1.2em;color:#009DFF">{$zr.nickname}：<em id="showmsg"><empty name="cache.ptgmsg">{$firstmsg}<else/>{$cache.ptgmsg}</empty></em></p>
				<p class="cutinfo t-c">单人购买价：<em class="bred">{$cache.payprice}元</em><em class="sgre">{$goodinfo.oprice}元</em></p>
				
				<p class="cutinfo t-c">拼团购,最多：<em class="bred"> {$goodinfo.groupmax} </em>人，每人只需<em class="bred"> {$goodinfo.groupprice}元</em>！</p>
				
				<!--<eq name="isself" value="1">					
					<p class="cutinfo t-c">已砍：<em class="bred"> {$totalcut} </em>刀，本单最高可砍<em class="bred"> ￥{$cache.cutmax}</em>！</p>
				<else/>
					<p class="cutinfo t-c">已砍：<em class="bred"> {$totalcut} </em>刀，您的一刀最高可砍<em class="bred"> ￥{$cache.cuttop}</em>！</p>
				</eq>-->
		</div>	
		<div class="odrd_cc back2 ovflw color9 border-b1 border-t1 mr-b" >
			<div class="border-b1 odrd_tt">玩法说明</div>
			<p style="line-height: 1.5em; font-size: 0.8em; font-weight: normal; margin: 5px 0px;">1:选择团购宣言</p>
			<select id="msgopt">
				<foreach name="ptgmsg" item="vo">
					<option value="{$vo}" <eq name="vo" value="$cache.ptgmsg">selected</eq>>{$vo}</option>	
				</foreach>
			</select>
			<p style="line-height: 1.5em;font-size: 0.8em;font-weight: normal;margin: 5px 0px;">2:点击右上角分享到朋友圈，让他们帮你团购吧！</p>
		</div>
		<!--团购发起者和玩法介绍div-->
		<!-- <div class="ptg-sj"></div>
		<div class="ptg-fqz">
			<img src="{$zr.headimgurl}" class="ptg-headicon FL" style="width:9%;">
			<div class="ptg-mst FL ptg-cor1"><p>团长{$zr.nickname}：</p></div>
			<div class="ptg-mst FL ptg-cor1"><p>{$vo.ctime|date="Y-m-d",###}开团</p></div>
			<div class="clear"></div>
		</div> -->
		<!--参团人员列表-->
		<!-- <div class="ptg-ct">		
				<div class="ptg-xy"></div>
				<img src="__PUBLIC__/wap/img/huojian.png" class="ptg-headicon FL" style="width:9%;">
				<div class="ptg-mst FL ptg-cor2"><p>还差18人参加</p></div>
				<div class="ptg-mst FL ptg-cor2"><p>2016-02-22 11:11:11参加</p></div>
			<div class="clear"></div>
		</div> -->
		<!--拼团购详情-->
		<!-- <div class="ptg-gz">          
			<div class="FL hdxq"><a href="#">拼团玩法</a></div>
			<div class="FR hdxq" style="text-align: right;"><a href="#">查看详情 ></a></div>
			<img src="__PUBLIC__/wap/img/ptgxq.jpg">
		</div> -->
		<!--团购发起者和玩法介绍div结束-->
		<div class="odrd_cc back2 ovflw color9 border-b1 border-t1 mr-b" >
			<div class="border-b1 odrd_tt">团购记录</div>
			<p style="line-height: 5px;">&nbsp;</p>
			<volist name="grouplog" id="vo">
			<div class="cutlog">
				<div class="left">
					<img src="{$vo.headimgurl}" class="headicon">
				</div>
				<p class="left2">
					{$vo.nickname}
				</p>
				<div class="right">
					<p class="t-r">支付成功,付款<em class="bred">{$vo.payprice}</em>元</p>
					<span>{$vo.ctime|date="Y-m-d",###}</span>
				</div>
				<div class="clear"></div>
			</div>
			</volist>
			<empty name="grouplog">
				<p>还没有人拼团购呢，你做第一个吧！</p>
			</empty>
		</div>
		<!-- 底部导航 -->
			<div class="J-btn">
				<eq name="isself" value="1">
					<empty name="_SESSION['WAP']['vip']['sid']">
						<eq name="isgroup" value="2">
							<a class="J-btn-gre" style="float: left;">您已参与团购</a>
						<else />
							<a href="/Wap/Shop/orderDetail/sid/0/orderid/{$cache.id}" class="J-btn-red2" style="float: left;">拼团购</a>
							
						</eq>
						<a href="/Wap/Shop/ptgorderList/sid/{$vip.sid}" class="J-btn-green">返回订单列表</a>
					<else />
						<eq name="isgroup" value="2">
							<a class="J-btn-gre" style="float: left;">您已参与团购</a>
						<else />
							<a href="/Wap/Fxshop/orderDetail/sid/{$vip.sid}/orderid/{$cache.id}" class="J-btn-red2" style="float: left;">拼团购</a>
						</eq>
						<a href="/Wap/fxshop/ptgorderList/sid/{$vip.sid}" class="J-btn-green">返回我的团</a>
						
					</empty>
				<else />
					<eq name="cache.isgroup" value="2">
						<eq name="isgroup" value="2">
							<a href="#" class="J-btn-gre">您已参与团购</a>
						<else/>
							<a id="fastbuy" class="J-btn-red2">拼团购</a>
						</eq>
					<else/>
						<a href="#" class="J-btn-gre">团购结束</a>
					</eq>
					<a href="/Wap/ptg/ptglist" class="J-btn-green">我也要玩</a>
			</eq>
			<div class="clear"></div>
			</div>
		<!--通用分享-->
		<script>
			
			var goodsnum=$('#goods-num');
			var goodsdec=$('#goods-dec');
			var goodsadd=$('#goods-add');
			var goodstotal=$('#goods-total');
			var addtocart=$('#addtocart');
			var fastbuy=$('#fastbuy');
			var basketnum=$('#basketnum');
			var bk =$('.dtl-bck');
			var vipid="{$_SESSION.WAP.vipid}";
			var ptgid="{$ptgid}";
			var goodsprice="{$groupprice}";
			var goodsid="{$goodid}";
			$(bk).on('click',function(){
				history.go(-1);
			})
			$(goodsadd).on('click',function(){
				var num=Number($(goodstotal).val());
				var left=Number($(goodsnum).html());
				var total=(num+1)<=left?(num+1):left;
				$(goodstotal).val(total);
				return false;
			});
			$(goodsdec).on('click',function(){
				var num=Number($(goodstotal).val());
				var total=(num-1)>=0?(num-1):0;
				$(goodstotal).val(total);
				return false;
			});
			
			//立刻购买特效
			$(fastbuy).on('click',function(){
//				alert(ptgid);
				var goodsnum=Number($('#goods-num').html());
				var num=Number($(goodstotal).val());
//				var finalsku=$('#finalsku');
				//sku模式
//				if(issku=='1'){
//					if(goodsnum-num <0){
//						Joel_gmuMsg('该属性产品库存不足！请调整购买量或选择其他属性！');
//						return false;
//					}
////					if(!$(finalsku).data('sku')){
////						Joel_gmuMsg('请选择产品属性！');
////						return false;
////					}
//				}else{
					if(goodsnum-num<0){
						Joel_gmuMsg('该产品库存不足！请调整购买量或选择其他属性！');
						return false;
					}
//				}

				if(!vipid){
					var fun=function(){
						window.location.href=loginback;
					}
					Joel_gmuMsg('您还未登录，2秒后自动跳转登陆界面！',fun);
					return false;
				}
//				var sku=$(finalsku).data('sku');
//				var skuattr=$(finalsku).data('skuattr');
				var price=goodsprice;
				var num=$(goodstotal).val();
				var ptgty="{$ptgty}";
				var sid = "{$vip.sid}";
				var dt={'sid':sid,'goodsid':goodsid,'vipid':vipid,'num':num,'ptgid':ptgid};
				//保证订单生成页的返回
				var orderurl="{:U('Wap/ptg/orderMake',array('sid'=>0,'ptgid'=>$ptgid,'lasturl'=>$lasturl,'ids'=>'ptg'))}";
				var fun=function(){
					window.location.href=orderurl;
				}
				var ajaxurl="{:U('Wap/ptg/fastbuy')}";
				$.ajax({
					type:"post",
					url:ajaxurl,
					dataType:'json',
					data:dt,
					success:function(info){
						if(info['status']){
							//Joel_gmuMsg(info['msg'],fun);
							window.location.href=orderurl;
						}else{
							Joel_gmuMsg('发生未知错误,请重新尝试！');
						}return false;
					},
					error:function(xh,obj){
						Joel_gmuMsg('通讯失败，请重试！');
					}
				});
				return false;
			});

			var id="{$cache.id}";
			var opts=$('#msgopt');
			var showmsg=$('#showmsg');
			$(opts).on('change',function(){
				var msg=$(this).val();
				$(showmsg).html(msg);
				$.ajax({
					type:"post",
					url:"{:U('Wap/Ptg/setMsg')}",
					dataType:'json',
					data:{'id':id,'msg':msg},
					success:function(info){
						if(info['status']){
							// alert(info['msg']);
							Joel_gmuMsg(info['msg']);
						}else{
							Joel_gmuMsg(info['msg']);
						}
						return false;
					},
					error:function(xh,obj){
						Joel_gmuMsg('通讯失败，请重试！');
					}
				});
			});
		</script>
		<!--新版分享特效-->
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script>
			var share_url = "{$_SESSION['SET']['wxurl']}/Wap/Ptg/index?ppid={$zr.id}&sid={$zr.sid}&ptgid={$ptgid}";
			var share_title="{$shopset['ptgname']}";
			var share_content="\n{$goodinfo['summary']}";
			var share_img="{$_SESSION['SET']['wxurl']}{$vt.pic}";
			//alert(share_url);
		   wx.config({
		      debug: false,
		      appId: "{$jsapi['appId']}",
			  timestamp: "{$jsapi['timestamp']}",
			  nonceStr: "{$jsapi['nonceStr']}",
			  signature: "{$jsapi['signature']}",
		      jsApiList: [
		        'checkJsApi',
		        'onMenuShareTimeline',
		        'onMenuShareAppMessage',
		        'onMenuShareQQ',
		        'onMenuShareWeibo',
		        'hideMenuItems',
		        'showMenuItems',
		        'hideAllNonBaseMenuItem',
		        'showAllNonBaseMenuItem',
				'translateVoice',
				'startRecord',
				'stopRecord',
				'onRecordEnd',
				'playVoice',
				'pauseVoice',
				'stopVoice',
				'uploadVoice',
				'downloadVoice',
				'chooseImage',
				'previewImage',
				'uploadImage',
				'downloadImage',
				'getNetworkType',
				'openLocation',
				'getLocation',
				'hideOptionMenu',
				'showOptionMenu',
				'closeWindow',
				'scanQRCode',
				'chooseWXPay',
				'openProductSpecificView',
				'addCard',
				'chooseCard',
				'openCard'
		      ]
		  });
		  
		  wx.ready(function () {
			  	//开启菜单
			  	wx.showOptionMenu();
			  	//隐藏菜单
			  	//wx.hideOptionMenu();
			    //分享给朋友
			    wx.onMenuShareAppMessage({
			      title: share_title,
			      desc: share_content,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击发送给朋友');
			        this.desc="来自{$zr.nickname}的邀请："+$('#showmsg').html()+"\n{$goodinfo['summary']}";
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
			    //分享到朋友圈
			    wx.onMenuShareTimeline({
			      title: share_title,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击分享到朋友圈');
			        this.title=share_title+'：'+$('#showmsg').html();
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
			    //分享到QQ
			    wx.onMenuShareQQ({
			      title: share_title,
			      desc: share_content,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击分享到QQ');
			        this.desc=$('#showmsg').html();
			      },
			      complete: function (res) {
			        //alert(JSON.stringify(res));
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
		  });
		</script>
	</body>
</html>