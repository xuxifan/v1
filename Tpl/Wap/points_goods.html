<!doctype html>
<html>
<head>
    <title>积分商城</title>
    <meta charset="utf-8" />
		<!--页面优化-->
		<meta name="MobileOptimized" content="320">
		<!--默认宽度320-->
		<meta name="viewport" content="width=device-width,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
		<!--viewport 等比 不缩放-->
		<meta http-equiv="cleartype" content="on">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<!--删除苹果菜单-->
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
		<!--默认颜色-->
		<meta name="apple-mobile-web-app-title" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<!--加载全部后 显示-->
		<meta content="telephone=no" name="format-detection" />
		<!--不识别电话-->
		<meta content="email=no" name="format-detection" />
	    <link rel="stylesheet" type="text/css" href="__PUBLIC__/wap/css/style.css" />
	    
	    <link rel="stylesheet" href="__PUBLIC__/wap/css/fxstyle.css" />
		<link rel="stylesheet" href="__PUBLIC__/wap/css/weui.min.css"/>
	    <link rel="stylesheet" href="__PUBLIC__/wap/css/weui.css"/>
	    <link rel="stylesheet" href="__PUBLIC__/wap/css/example.css"/>
	    
	    <!--组件依赖js begin-->
	    <script src="__PUBLIC__/wap/gmu/zepto.min.js"></script>
	    <!--组件依赖js end-->		
		<script type="text/javascript" src="__PUBLIC__/wap/gmu/gmu.min.js"></script>
        <script type="text/javascript" src="__PUBLIC__/wap/gmu/Joel-basegmu.js"></script>
		<style>
			
			.FL{
				float:left;
				}
			.FR{
				float:right;
				}
			.xqtu{
				width:100%;
				margin:5px 0;
				border-top:1px solid #cccccc;
				border-bottom:1px solid #cccccc;
			}
			.clr{
				clear:both;
			}

		.fo1{font-size:0.85em;}
		.padd3{padding: 0 3px;border-radius: 5px;}
		.marginT10{margin-top: 5px;}
		.menu{display:block;height:40px;width:100%;max-width:720px}
		.menu a{text-decoration:none;}
		.m-fix{position:fixed;top:0px;z-index:99;}
		.m-box{margin:5px 10px 5px 10px;height:30px;}
		.m-box img{display:block;height:30px;width:30px;border-radius:15px;}
		.m-bgc1{background:black;}
		.m-bgc2{background:white;}
		.m-bgc3{background:red;}
		.m-search{font-size:20px;}
		.m-box-sbox{margin:0 5px;}

			.per_count {
			    display: inline-block;
			    width: 11px;
			    height: 10px;
			    background: url(http://static.xiaojukeji.com/activity/img-mall/per_count.png) right bottom no-repeat;
			    background-size: 8px 10px;
			    position: relative;
			    top: 1px;
			}
			.points-money {
				font-size: 30px;
				color: #FF8F00;
			}
			.points-status {
				font-weight: 700;
				margin-top: 6%;
				font-size: 18px;
				padding: 2px 25px;
				background: #FF8F00;
				color: #ffffff;
				border-radius: 3px;
			}
			#fix-buy {
				position: fixed;
				width:100%;
				top: 0px;
				opacity:0.95;
				display: none;
			}
		</style>
		</head> 
		<body>
				<!-- 固定部分 -->
				<div id="fix-buy">
				<div class="ads-lst border-t1 border-b1 ovflw mr-b back2">
					<div class="clr"></div>
					<div class="FL">
						<p class="points-money">{$cache.integpay}<span class="per_count" style="color:yellow;"></span></p>
					</div>
					<div class="FR">
						
						<div class="points-status">
							立即兑换
						</div>
					</div>
					<div class="clr"></div>
				</div>
				</div>
				<!-- 固定部分 -->
				<div class="tuan-tu">
					<img src="{$cache.imgurl}" width="100%">
				</div>
				
				<div id="buy" class="ads-lst border-t1 border-b1 ovflw mr-b back2">
					<div class="clr"></div>
					<div class="FL">
						<p class="points-money">{$cache.integpay}<span class="per_count" style="color:yellow;"></span></p>
					</div>
					<div class="FR">
						<div class="points-status">
							立即兑换
						</div>
					</div>
					<div class="clr"></div>
				</div>
			
			<div class="ads-lst border-t1 border-b1 ovflw mr-b back2">
				 <div class="ads_pay2 ovflw" data-disable="0" id="x2">
				 		<em class="dtl-prc color6 ads_pay2_lineh FL"><i class="iconfont">&#xe676;&nbsp;</i><i id=" goods-price">{$_SESSION['WAP']['shopset']['name']}</i></em>
					    <empty name="$sid">
							<a href="{$_SESSION['WAP']['shopset']['url']}/wap/shop/index" style="float: right; margin: 6px; color: #acacac;">
						<else />
							<a href="{$_SESSION['WAP']['shopset']['url']}/wap/fxshop/index" style="float: right; margin: 6px; color: #acacac;">
						</empty>
					    	
					       进入店铺>></a>
					    
				</div>	
			</div>
			
			<div class="ads-lst border-t1 border-b1 ovflw mr-b back2" style=" padding: 10px 6px 10px 11px">
				{$cache.content|htmlspecialchars_decode}
			</div>
			<!--<div class="tuan-fg"></div>-->
		<!--通用分享-->
		<!--<eq name="_SESSION['WAP']['vip']['sid']" value="1">
		<include file="./Tpl/Wap/fxshop_share.html" />
		<else />
		<include file="./Tpl/Wap/shop_share.html" />
		</eq>-->
		<script>
			// 顶部js
			var buy_top = $("#buy").position().top;
			$(window).scroll(function(){
				var window_top=$(window).scrollTop();
				if(window_top>buy_top){
					$("#fix-buy").show();
				}else{
					$("#fix-buy").hide();
				}
			})
			// 顶部js
			
			
			$(function(){

				var vscore="{$vscore}";
				var payscore="{$payscore}";
				var gnum="{$gnum}";
				var vipid="{$vipid}";
				var loginback="{$loginback}";
				var goodsid="{$cache.id}";
				gnum=Number(gnum);
				payscore=Number(payscore);
				vscore=Number(vscore);
				//如果积分不够该商品支付的积分数或该产品的库存不够
				if(vscore < payscore || gnum == '0'){
					$(".points-status").css({'background':'#C7C3BE'});
					if(gnum=='0'){
						$(".points-status").text("已售罄");
						return false;
					}
					if(vscore<payscore){
						$(".points-status").text("积分不足");
						return false;
					}
					$(".points-status").click(function(){
						
						if(!vipid){
							var fun=function(){
								window.location.href=loginback;
							}
							Joel_gmuMsg('您还未登录，2秒后自动跳转登陆界面！',fun);
							return false;
						}
					})
				}else{
					$(".points-status").css({'background':'#FF8F00'});
					$(".points-status").click(function(){
						
						if(!vipid){
							var fun=function(){
								window.location.href=loginback;
							}
							Joel_gmuMsg('您还未登录，2秒后自动跳转登陆界面！',fun);
							return false;
						}
						
						var checkidfun = function (){
						window.location.href="{:U('wap/vip/info')}";
					}
					if("{$ischeckid}"==1){
						$.ajax({
							type:"post",
							url:"{:U('Wap/Points/checkidentify')}",
							success:function(info){
								if(!info['status']){
									Joel_gmuMsg(info['msg'],checkidfun);
									return false;
								}else{
									buy();
								}
							},
							error:function(xh,obj){
								Joel_gmuMsg('通讯失败，请重试！');
							}
						});
					}else{
						buy();
					}
					function buy(){
						var price=payscore;
						var num='1';
						var dt={'sid':0,'goodsid':goodsid,'vipid':vipid,'num':num};
						//保证订单生成页的返回
						var orderurl="{:U('Wap/Points/orderMake',array('sid'=>0,'lasturl'=>$lasturl))}";
						var fun=function(){
							
							window.location.href=orderurl;
						}
						$.ajax({
							type:"post",
							url:"{:U('Wap/Points/fastbuy')}",
							dataType:'json',
							data:dt,
							success:function(info){if(info['status']){Joel_gmuMsg(info['msg'],fun);}else{Joel_gmuMsg('发生未知错误,请重新尝试！');}return false;},
							error:function(xh,obj){
								Joel_gmuMsg('通讯失败，请重试！');
							}
						});
						return false;
					}
					})
				}
			})
			
		</script>
		<!--新版分享特效-->
		<script src="http://res.wx.qq.com/open/js/jweixin-1.0.0.js"></script>
		<script>
			var share_url = "{$_SESSION['WAP']['shopset']['url']}/Wap/Points/goods/ppid/{$_SESSION['WAP']['vipid']}/id/{$cache.id}";
			var share_title="{$_SESSION['WAP']['shopset']['name']}-{$cache.name}";
			var share_content="{$cache['summary']}";
			var share_img="{$_SESSION['WAP']['shopset']['url']}{$cache.imgurl}";
			
		  wx.config({
		      debug: false,
		      appId: "{$jsapi['appId']}",
			  timestamp: "{$jsapi['timestamp']}",
			  nonceStr: "{$jsapi['nonceStr']}",
			  signature: "{$jsapi['signature']}",
		      jsApiList: [
		        'checkJsApi',
		        'onMenuShareTimeline',
		        'onMenuShareAppMessage',
		        'onMenuShareQQ',
		        'onMenuShareWeibo',
		        'hideMenuItems',
		        'showMenuItems',
		        'hideAllNonBaseMenuItem',
		        'showAllNonBaseMenuItem',
		//      'translateVoice',
		//      'startRecord',
		//      'stopRecord',
		//      'onRecordEnd',
		//      'playVoice',
		//      'pauseVoice',
		//      'stopVoice',
		//      'uploadVoice',
		//      'downloadVoice',
		//      'chooseImage',
		//      'previewImage',
		//      'uploadImage',
		//      'downloadImage',
		//      'getNetworkType',
		//      'openLocation',
		//      'getLocation',
		//      'hideOptionMenu',
		//      'showOptionMenu',
		//      'closeWindow',
		//      'scanQRCode',
		//      'chooseWXPay',
		//      'openProductSpecificView',
		//      'addCard',
		//      'chooseCard',
		//      'openCard'
		      ]
		  });
		  
		  wx.ready(function () {
			  	//开启菜单
			  	wx.showOptionMenu();
			  	//隐藏菜单
			  	//wx.hideOptionMenu();
			    //分享给朋友
			    wx.onMenuShareAppMessage({
			      title: share_title,
			      desc: share_content,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击发送给朋友');
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
			    //分享到朋友圈
			    wx.onMenuShareTimeline({
			      title: share_title,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击分享到朋友圈');
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
			    //分享到QQ
			    wx.onMenuShareQQ({
			      title: share_title,
			      desc: share_content,
			      link: share_url,
			      imgUrl: share_img,
			      trigger: function (res) {
			        //alert('用户点击分享到QQ');
			      },
			      complete: function (res) {
			        //alert(JSON.stringify(res));
			      },
			      success: function (res) {
			        //alert('已分享');
			      },
			      cancel: function (res) {
			        //alert('已取消');
			      },
			      fail: function (res) {
			        //alert(JSON.stringify(res));
			      }
			    });
		  });
		</script>
	</body>

</html>